# .github/workflows/daily-api-scanner.yml

name: Daily API Change Scanner

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout latest repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download previous repository state (from artifact)
        run: |
          gh run download --repo ${{ github.repository }} --artifact previous-repo-state --dir ./previous-state || echo "No previous artifact found, skipping download."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Compare with previous state and get changed files
        id: get_diff
        run: |
          # Use the new GITHUB_OUTPUT method
          echo "diff_found=false" >> $GITHUB_OUTPUT
          
          if [ -d "./previous-state/repo-state" ]; then
            git diff --name-only $(git hash-object -t tree -w previous-state/repo-state) HEAD > changed_files.txt
            if [ -s changed_files.txt ]; then
              echo "diff_found=true" >> $GITHUB_OUTPUT
            fi
          else
            find . -name "*.java" > changed_files.txt
            echo "diff_found=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Run Endpoint Extractor on changed files
        if: steps.get_diff.outputs.diff_found == 'true'
        run: |
          python scripts/extract_endpoints.py --files changed_files.txt

      - name: Upload current repository state as artifact for next run
        # This is the crucial step that saves the current repository state to be used as a cache tomorrow
        uses: actions/upload-artifact@v4
        with:
          name: previous-repo-state
          path: .
          retention-days: 7
