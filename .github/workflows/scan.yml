name: Consolidated API Endpoint Analysis

on:
  push:
    branches:
      - main
      - qa
  pull_request:
    branches:
      - main
      - qa
  workflow_dispatch:

jobs:
  analyze-and-process-endpoints:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository with limited history
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run Endpoint Extractor Script
        id: extract_endpoints
        run: python scripts/extract_endpoints.py

      - name: Process and Display Found Endpoints
        if: steps.extract_endpoints.outputs.endpoints_found == 'true'
        run: |
          echo "--- Processing Found Endpoints ---"
          if [ -f "changed_endpoints.json" ]; then
            NUM_ENDPOINTS=$(jq length changed_endpoints.json)
            if [ "$NUM_ENDPOINTS" -gt 0 ]; then
              echo "🎉 Found $NUM_ENDPOINTS API endpoints from changed Java files."
              echo "Content of changed_endpoints.json:"
              cat changed_endpoints.json
              echo ""
              echo "Full Endpoint URLs:"
              jq -r '.[].path' changed_endpoints.json
              echo ""
              echo "Methods and Paths:"
              jq -r '.[] | "\(.method) \(.path)"' changed_endpoints.json
            else
              echo "✅ No API endpoints were found in the changed Java files."
            fi
          else
            echo "⚠️ 'changed_endpoints.json' was not generated by the previous step."
          fi

      - name: Setup Nuclei and Print Version
        if: steps.extract_endpoints.outputs.endpoints_found == 'true'
        run: |
          echo "✨ Installing Nuclei..."
          sudo apt-get update -yq
          sudo apt-get install -yq wget unzip
          wget -q https://github.com/projectdiscovery/nuclei/releases/download/v2.9.8/nuclei_2.9.8_linux_amd64.zip -O nuclei.zip
          unzip nuclei.zip
          sudo mv nuclei /usr/local/bin/

          echo "✅ Nuclei installed. Version:"
          # nuclei -version
          echo "🚀 Running Nuclei scan on detected endpoints..."
          
          # Extract only the URLs from the JSON file and feed them to Nuclei
          jq -r '.[].path' changed_endpoints.json > urls_for_nuclei.txt
          
          # Run Nuclei with the list of URLs
          nuclei -id http-missing-security-headers -l urls_for_nuclei.txt -silent -o nuclei_results.txt
          
          echo "Nuclei scan complete. Results saved to nuclei_results.txt"
          # cat nuclei_results.txt
          # Check if the results file is not empty (-s checks for size > 0)
          if [ -s nuclei_results.txt ]; then
              exit 1 # This command fails the step and the job
          else
              echo "✅ No vulnerabilities were found in the API endpoints."
          fi
